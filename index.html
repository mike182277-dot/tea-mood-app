<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TeaMood</title>
    
    <!-- PWA Meta Tags for a better mobile experience -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f5f5f4">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">
    
    <!-- React & Babel for JSX in browser -->
    <script src="https://unpkg.com/react@17/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: 'Lora', serif;
            -webkit-tap-highlight-color: transparent; /* Disable tap highlight on iOS */
        }
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #444; }

        /* Simple CSS Transitions for the bottom sheet */
        .sheet-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .sheet-content {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
// Inlined SVG Icons to replace lucide-react library
const Leaf = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 text-rose-800 dark:text-amber-400"><path d="M11 20A7 7 0 0 1 4 13H2a10 10 0 0 0 10 10z"/><path d="M12 21a10 10 0 0 0 10-10h-2a7 7 0 0 1-7 7z"/><path d="M12 12v-1a4 4 0 0 0-4-4H2"/><path d="M16 8a4 4 0 0 0-4-4v1a3 3 0 0 1 3 3h1Z"/></svg>);
const Moon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>);
const Sun = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>);
const SearchIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>);
const SearchIconForInput = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4 absolute left-3.5 top-1/2 -translate-y-1/2 text-zinc-400 dark:text-zinc-500"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>);
const Heart = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>);
const HeartOff = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>);
const Timer = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="12" y1="14" y2="18"/><path d="M19 11a7 7 0 1 0-7 7v-1"/><path d="M12 8v4l2 1"/></svg>);
const BookOpen = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>);
const Play = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" className="w-5 h-5"><polygon points="5 3 19 12 5 21 5 3"/></svg>);
const Pause = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" className="w-5 h-5"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>);
const StopCircle = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><circle cx="12" cy="12" r="10"/><rect x="9" y="9" width="6" height="6"/></svg>);
const ChevronDownIcon = () => (<svg viewBox="0 0 24 24" className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>);

// Destructuring React hooks for convenience
const { useEffect, useMemo, useRef, useState } = React;

// ---------------------------
// ДАННЫЕ
// ---------------------------

const TEAS = [
    { id: "longjing", name: "Longjing (Dragon Well)", cn: "龍井", category: "green", region: "Hangzhou, Zhejiang", notes: ["ореховый", "злаки", "сладковатый", "свежий"], caffeine: 2, moods: ["focus", "calm"], tempC: 80, gramsPer100: 2.5, infusions: [10, 15, 20, 25], story: "Классика зелёного чая: мягкая ореховость и ясная голова — отличный компаньон для работы." },
    { id: "biluochun", name: "Biluochun", cn: "碧螺春", category: "green", region: "Jiangsu", notes: ["фруктовый", "цветочный", "свежий"], caffeine: 2, moods: ["focus", "energy"], tempC: 80, gramsPer100: 2, infusions: [8, 12, 18, 25] },
    { id: "silver-needle", name: "Baihao Yinzhen (Silver Needle)", cn: "白毫银针", category: "white", region: "Fuding, Fujian", notes: ["медовый", "шёлковый", "деликатный"], caffeine: 1, moods: ["calm", "romance", "sleep"], tempC: 85, gramsPer100: 3, infusions: [20, 25, 30, 40] },
    { id: "bai-mudan", name: "Bai Mudan (White Peony)", cn: "白牡丹", category: "white", notes: ["фруктовый", "сочный", "мягкий"], caffeine: 1, moods: ["calm", "reflect", "romance"], tempC: 85, gramsPer100: 3, infusions: [20, 25, 35, 45] },
    { id: "junshan-yinzhen", name: "Junshan Yinzhen", cn: "君山银针", category: "yellow", region: "Hunan", notes: ["маслянистый", "мягкий", "редкий"], caffeine: 1, moods: ["calm", "reflect", "romance"], tempC: 85, gramsPer100: 3, infusions: [20, 25, 30] },
    { id: "tieguanyin", name: "Tie Guan Yin", cn: "铁观音", category: "oolong", region: "Anxi, Fujian", notes: ["цветочный", "сливочный", "нектарный"], caffeine: 2, moods: ["romance", "social", "calm"], tempC: 95, gramsPer100: 6, infusions: [10, 12, 15, 20, 25, 35] },
    { id: "dahongpao", name: "Da Hong Pao", cn: "大红袍", category: "oolong", region: "Wuyi, Fujian", notes: ["минералы", "карамель", "запечённый"], caffeine: 2, moods: ["reflect", "focus", "romance"], tempC: 98, gramsPer100: 6, infusions: [8, 10, 12, 15, 20, 30], story: "Скалы Уи — плотный, задумчивый улун с минералами и карамелью. Хорош для глубоких размышлений." },
    { id: "dancong", name: "Phoenix Dancong", cn: "凤凰单枞", category: "oolong", region: "Guangdong", notes: ["манго", "персик", "цветочный"], caffeine: 2, moods: ["romance", "social", "energy"], tempC: 96, gramsPer100: 6, infusions: [8, 10, 12, 15, 18, 25] },
    { id: "keemun", name: "Keemun", cn: "祁门红茶", category: "red", region: "Anhui", notes: ["шоколад", "слад", "цитрус"], caffeine: 3, moods: ["energy", "focus", "social"], tempC: 95, gramsPer100: 2.5, infusions: [15, 25, 35] },
    { id: "dianhong", name: "Dian Hong", cn: "滇红", category: "red", region: "Yunnan", notes: ["карамель", "мёд", "плотный"], caffeine: 3, moods: ["energy", "social"], tempC: 95, gramsPer100: 2.5, infusions: [15, 25, 35] },
    { id: "lapsang", name: "Lapsang Souchong", cn: "正山小种", category: "red", region: "Fujian (smoked)", notes: ["дым", "сосна", "сладкий дымок"], caffeine: 3, moods: ["reflect", "energy"], tempC: 95, gramsPer100: 2.5, infusions: [10, 20, 30] },
    { id: "shu-puer", name: "Shu Pu-erh", cn: "熟普洱", category: "dark", region: "Yunnan", notes: ["землистый", "какао", "древесный"], caffeine: 2, moods: ["reflect", "stress"], tempC: 98, gramsPer100: 6, infusions: [8, 10, 12, 15, 20, 30], rinse: true },
    { id: "sheng-puer", name: "Sheng Pu-erh (young)", cn: "生普洱", category: "dark", notes: ["травянистый", "винный", "энергичный"], caffeine: 3, moods: ["energy", "focus"], tempC: 95, gramsPer100: 5, infusions: [8, 10, 12, 15, 20, 25], rinse: true },
    { id: "jasmine", name: "Jasmine Green", category: "floral", notes: ["жасмин", "сладкий", "ароматный"], caffeine: 2, moods: ["romance", "calm", "social"], tempC: 85, gramsPer100: 2.5, infusions: [10, 15, 25, 35] },
    { id: "osmanthus-oolong", name: "Osmanthus Oolong", category: "floral", notes: ["османтус", "абрикос", "мёд"], caffeine: 2, moods: ["romance", "social", "calm"], tempC: 90, gramsPer100: 5, infusions: [8, 10, 12, 15, 20] },
    { id: "chrysanthemum-shu", name: "Chrysanthemum + Shu Pu-erh", category: "floral", notes: ["цветочный", "успокаивающий", "баланс"], caffeine: 2, moods: ["stress", "reflect", "calm"], tempC: 95, gramsPer100: 5, infusions: [10, 12, 15, 20, 30] },
];

const MOODS = {
  calm: { label: "Спокойствие", emoji: "😌" },
  focus: { label: "Фокус", emoji: "🧠" },
  energy: { label: "Энергия", emoji: "⚡" },
  romance: { label: "Романтика", emoji: "🌸" },
  reflect: { label: "Размышление", emoji: "🌌" },
  stress: { label: "Анти-стресс", emoji: "🫖" },
  social: { label: "Компания", emoji: "👥" },
  sleep: { label: "К сну", emoji: "😴" },
};

const CATEGORY_LABELS = { 
    green: "Зелёный", 
    white: "Белый", 
    yellow: "Жёлтый", 
    oolong: "Улун", 
    red: "Красный", 
    dark: "Чёрный", 
    floral: "Цветочный" 
};

const MOOD_WEIGHTS = {
  calm: { white: 1, yellow: 0.8, floral: 0.7, green: 0.6, dark: 0.5 },
  focus: { green: 1, oolong: 0.9, dark: 0.7, red: 0.6 },
  energy: { red: 1, oolong: 0.9, green: 0.7, 'dark': 0.9 },
  romance: { oolong: 1, white: 0.8, floral: 0.9 },
  reflect: { dark: 1, oolong: 0.8, red: 0.7 },
  stress: { dark: 1, floral: 0.8, white: 0.7 },
  social: { red: 1, oolong: 0.9, floral: 0.7 },
  sleep: { white: 1, yellow: 0.8, floral: 0.7 },
};

// ---------------------------
// УТИЛИТЫ
// ---------------------------

function classNames(...arr) {
  return arr.filter(Boolean).join(" ");
}

function scoreTea(tea, mood) {
  const catWeight = MOOD_WEIGHTS[mood][tea.category] ?? 0.5;
  const moodTagBoost = tea.moods.includes(mood) ? 0.4 : 0;
  const caffeineBoost = mood === "sleep" ? (tea.caffeine === 1 ? 0.2 : -0.3) : 0;
  return catWeight + moodTagBoost + caffeineBoost;
}

function useLocalStorage(key, initial) {
  const [state, setState] = useState(() => {
    try {
      if (typeof window !== 'undefined') {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : initial;
      }
    } catch {}
    return initial;
  });
  useEffect(() => {
    try {
      if (typeof window !== 'undefined') {
        localStorage.setItem(key, JSON.stringify(state));
      }
    } catch {}
  }, [key, state]);
  return [state, setState];
}

// ---------------------------
// КОМПОНЕНТЫ UI
// ---------------------------

function TopBar({ title, theme, toggleTheme }) {
  return (
    <div className="sticky top-0 z-40 bg-stone-50/70 dark:bg-zinc-900/70 backdrop-blur border-b border-stone-200 dark:border-zinc-800">
      <div className="max-w-screen-sm mx-auto px-4 py-3 flex items-center gap-3">
        <Leaf />
        <div className="font-semibold text-zinc-900 dark:text-stone-100 tracking-tight">{title}</div>
        <div className="ml-auto flex items-center gap-2 sm:gap-4">
            <button onClick={toggleTheme} className="p-2 -m-2 rounded-full text-zinc-500 dark:text-zinc-400 hover:bg-stone-200 dark:hover:bg-zinc-800 transition-colors">
                {theme === 'light' ? <Moon /> : <Sun />}
            </button>
            <div className="text-xs text-zinc-500 tracking-widest hidden sm:block">BETA</div>
        </div>
      </div>
    </div>
  );
}

function BottomNav({ tab, setTab }) {
  const items = [
    { key: "mood", label: "Настрой", icon: <Sun /> },
    { key: "explore", label: "Выбор", icon: <SearchIcon /> },
    { key: "brew", label: "Процесс", icon: <Timer /> },
    { key: "journal", label: "Журнал", icon: <BookOpen /> },
  ];
  return (
    <div className="fixed bottom-0 left-0 right-0 z-40 bg-stone-50/80 dark:bg-zinc-900/80 backdrop-blur border-t border-stone-200 dark:border-zinc-800">
      <div className="max-w-screen-sm mx-auto grid grid-cols-4">
        {items.map((it) => (
          <button
            key={it.key}
            onClick={() => setTab(it.key)}
            className={classNames(
              "py-3 text-xs flex flex-col items-center gap-1 tracking-wide transition-colors duration-200",
              tab === it.key ? "text-rose-800 dark:text-amber-400 font-semibold" : "text-zinc-500 dark:text-zinc-400"
            )}
          >
            {it.icon}
            <span>{it.label}</span>
          </button>
        ))}
      </div>
    </div>
  );
}

function MoodChip({ mood, selected, onSelect }) {
  const m = MOODS[mood];
  return (
    <button
      onClick={() => onSelect(mood)}
      className={classNames(
        "px-3 py-2 rounded-2xl border text-sm flex items-center gap-2 shadow-sm transition-colors",
        selected ? "bg-rose-800 text-white border-rose-800 dark:bg-amber-400 dark:text-zinc-900 dark:border-amber-400" : "bg-white border-stone-300 hover:bg-stone-50 dark:bg-zinc-800 dark:border-zinc-700 dark:hover:bg-zinc-700"
      )}
    >
      <span className="text-lg">{m.emoji}</span>
      <span className="font-medium tracking-wide">{m.label}</span>
    </button>
  );
}

function CategoryBadge({ cat }) {
    const label = CATEGORY_LABELS[cat];
    const styles = {
        green: "bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300",
        white: "bg-stone-200 text-stone-700 dark:bg-stone-700 dark:text-stone-200",
        yellow: "bg-amber-100 text-amber-800 dark:bg-amber-800/50 dark:text-amber-300",
        oolong: "bg-orange-100 text-orange-800 dark:bg-orange-900/50 dark:text-orange-300",
        red: "bg-rose-100 text-rose-800 dark:bg-rose-900/50 dark:text-rose-300",
        dark: "bg-zinc-300 text-zinc-800 dark:bg-zinc-700 dark:text-zinc-200",
        floral: "bg-pink-100 text-pink-800 dark:bg-pink-900/50 dark:text-pink-300",
    };
    return (<span className={classNames("px-2 py-1 rounded-full text-sm font-medium", styles[cat])}>{label}</span>);
}

function TeaCard({ tea, onOpen, fav, toggleFav }) {
  return (
    <div
      className="rounded-3xl bg-white dark:bg-zinc-800/80 border border-stone-200 dark:border-zinc-700 shadow-sm overflow-hidden transition-transform transform hover:scale-[1.02]"
    >
      <div className="p-4 flex items-start gap-4">
        <div className="shrink-0 w-12 h-12 rounded-2xl bg-gradient-to-br from-stone-100 to-stone-200 dark:from-zinc-700 dark:to-zinc-600 grid place-items-center">
          <Leaf />
        </div>
        <div className="min-w-0 flex-1">
          <div className="flex items-center gap-2 flex-wrap">
            <h3 className="font-semibold text-zinc-900 dark:text-stone-100 truncate tracking-wide">{tea.name}</h3>
            <CategoryBadge cat={tea.category} />
          </div>
          <div className="text-sm text-zinc-600 dark:text-stone-300 line-clamp-2 mt-1">{tea.notes.join(" · ")}</div>
          <div className="flex items-center gap-3 mt-3 text-xs text-zinc-500 dark:text-zinc-400">
            <span>{"⚡".repeat(tea.caffeine)}</span><span>🌡️ {tea.tempC}°C</span><span>⚖️ {tea.gramsPer100} г/100мл</span>
          </div>
          {tea.story && <div className="text-xs text-zinc-500 dark:text-zinc-400 mt-2 line-clamp-2">{tea.story}</div>}
          <div className="flex items-center gap-2 mt-4 flex-wrap">
            <button onClick={() => onOpen(tea)} className="px-4 py-2 rounded-xl bg-rose-700 text-white text-sm font-medium hover:bg-rose-800 dark:bg-amber-400 dark:text-zinc-900 dark:hover:bg-amber-300 transition-colors tracking-wide">Заварить</button>
            <button onClick={() => toggleFav(tea.id)} className={classNames("px-4 py-2 rounded-xl border text-sm font-medium transition-colors", fav ? "border-rose-600 text-white bg-rose-600 hover:bg-rose-700 dark:bg-amber-400 dark:text-zinc-900 dark:border-amber-400 dark:hover:bg-amber-300" : "border-stone-300 text-zinc-700 bg-white hover:bg-stone-50 dark:border-zinc-600 dark:bg-zinc-800 dark:text-stone-200 dark:hover:bg-zinc-700")}>
              {fav ? (<span className="inline-flex items-center gap-1.5"><Heart /> <span className="tracking-wide">В избранном</span></span>) : (<span className="inline-flex items-center gap-1.5"><HeartOff /> <span className="tracking-wide">В избранное</span></span>)}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Sheet({ tea, open, onClose, onStartBrew }) {
  useEffect(() => {
    if (open) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'auto';
    }
    return () => document.body.style.overflow = 'auto';
  }, [open]);

  return (
    <div className={classNames("fixed inset-0 z-50 transition-opacity", open ? "opacity-100" : "opacity-0 pointer-events-none")}>
      <div className="absolute inset-0 bg-black/50 dark:bg-black/70" onClick={onClose} />
      <div 
        className="sheet-content absolute inset-x-0 bottom-0 bg-stone-50 dark:bg-zinc-900 rounded-t-3xl shadow-2xl max-w-screen-sm mx-auto max-h-[90vh] overflow-y-auto"
        style={{ transform: open ? 'translateY(0)' : 'translateY(100%)' }}
      >
        <div className="sticky top-0 bg-stone-50 dark:bg-zinc-900 p-4 border-b border-stone-200 dark:border-zinc-800 flex items-center gap-3">
          <button className="p-2 -m-2" onClick={onClose}><ChevronDownIcon /></button>
          <div className="font-semibold text-lg tracking-wide text-zinc-900 dark:text-stone-100">{tea?.name}</div>
          <div className="ml-auto">{tea && <CategoryBadge cat={tea.category} />}</div>
        </div>
        {tea && <div className="p-4 space-y-4">
          <div className="text-sm text-zinc-600 dark:text-stone-300">{tea.story ?? "Подробности о чае, происхождение и рекомендации по завариванию."}</div>
          <div className="grid grid-cols-3 gap-3 text-sm">
            <Spec label="Температура" value={`${tea.tempC}°C`} />
            <Spec label="Доза" value={`${tea.gramsPer100}г/100мл`} />
            <Spec label="Кофеин" value={`⚡`.repeat(tea.caffeine)} />
          </div>
          <div>
            <div className="text-xs uppercase tracking-widest text-zinc-500 dark:text-zinc-400">Проливы</div>
            <div className="mt-2 flex flex-wrap gap-2">
              {tea.infusions.map((sec, i) => (<span key={i} className="px-2 py-1 rounded-lg bg-stone-200 dark:bg-zinc-800 text-zinc-700 dark:text-stone-200 text-sm">{sec}с</span>))}
              {tea.rinse && <span className="px-2 py-1 rounded-lg bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300 text-sm">Промывка</span>}
            </div>
          </div>
          <div className="text-sm text-zinc-600 dark:text-stone-300">Ноты вкуса: {tea.notes.join(" · ")}</div>
          <div className="pt-2">
            <button onClick={() => onStartBrew(tea)} className="w-full px-4 py-3 rounded-2xl bg-rose-700 text-white font-medium flex items-center justify-center gap-2 hover:bg-rose-800 dark:bg-amber-400 dark:text-zinc-900 dark:hover:bg-amber-300 transition-colors tracking-widest"><Timer /> НАЧАТЬ</button>
          </div>
        </div>}
      </div>
    </div>
  );
}

function Spec({ label, value }) {
  return (
    <div className="rounded-2xl border border-stone-200 dark:border-zinc-800 p-3 bg-white dark:bg-zinc-800/50">
      <div className="text-[10px] uppercase tracking-widest text-zinc-500 dark:text-zinc-400">{label}</div>
      <div className="mt-1 font-medium text-zinc-900 dark:text-stone-100">{value}</div>
    </div>
  );
}

function useBrewTimer() {
  const [state, setState] = useState({ step: 0, left: 0, running: false });
  const intervalRef = useRef(null);
  useEffect(() => () => { if (intervalRef.current) window.clearInterval(intervalRef.current); }, []);
  function start(tea) {
    if (intervalRef.current) window.clearInterval(intervalRef.current);
    setState({ tea, step: 0, left: tea.infusions[0] ?? 0, running: true });
    intervalRef.current = window.setInterval(() => {
      setState((s) => {
        if (!s.running || !s.tea) return s;
        if (s.left > 1) return { ...s, left: s.left - 1 };
        const nextStep = (s.step + 1);
        const nextDur = s.tea.infusions[nextStep];
        if (nextDur !== undefined) return { ...s, step: nextStep, left: nextDur };
        if (intervalRef.current) window.clearInterval(intervalRef.current);
        return { ...s, running: false, left: 0 };
      });
    }, 1000);
  }
  function pause() { setState((s) => ({ ...s, running: false })); }
  function resume() { setState((s) => ({ ...s, running: true })); }
  function stop() {
    if (intervalRef.current) window.clearInterval(intervalRef.current);
    setState({ step: 0, left: 0, running: false, tea: state.tea });
  }
  function setTea(tea) {
    stop();
    setState({ tea, step: 0, left: 0, running: false });
  }
  return { state, start, pause, resume, stop, setTea };
}

function BrewPanel({ brew, onPickTea }) {
  const { state, pause, resume, stop, start } = brew;
  const tea = state.tea;
  const handleStart = () => { if (tea) start(tea); }
  return (
    <div className="p-4">
      {!tea ? (
        <div className="rounded-3xl border border-dashed border-stone-300 dark:border-zinc-700 p-6 text-center text-zinc-600 dark:text-zinc-400">
          <div className="text-xl tracking-wide">Чай не выбран</div>
          <div className="mt-2">Найди свой чай во вкладках</div>
          <button onClick={onPickTea} className="mt-4 px-4 py-2 rounded-xl bg-rose-700 hover:bg-rose-800 text-white dark:bg-amber-400 dark:text-zinc-900 dark:hover:bg-amber-300 tracking-widest">ВЫБРАТЬ</button>
        </div>
      ) : (
        <div className="space-y-4">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 rounded-2xl bg-stone-200 dark:bg-zinc-800 grid place-items-center"><Leaf /></div>
            <div>
              <div className="font-semibold tracking-wide text-zinc-900 dark:text-stone-100">{tea.name}</div>
              <div className="text-sm text-zinc-500 dark:text-zinc-400">Пролив {state.left > 0 ? state.step + 1 : state.step} из {tea.infusions.length}</div>
            </div>
          </div>
          <div className="rounded-3xl bg-zinc-800 dark:bg-stone-100 text-white dark:text-zinc-900 p-6 flex items-center justify-between">
            <div className="text-sm opacity-80 dark:opacity-60 tracking-widest">ВРЕМЯ</div>
            <div className="text-5xl font-mono tabular-nums">{state.left.toString().padStart(2, '0')}с</div>
          </div>
          <div className="grid grid-cols-2 gap-2">
            {!state.running && state.left === 0 && (<button onClick={handleStart} className="w-full px-4 py-3 rounded-2xl border-transparent bg-rose-700 text-white dark:bg-amber-400 dark:text-zinc-900 flex items-center justify-center gap-2 tracking-widest"><Play />СТАРТ</button>)}
            {state.running && (<button onClick={pause} className="w-full px-4 py-3 rounded-2xl border border-stone-300 dark:border-zinc-700 flex items-center justify-center gap-2 tracking-widest"><Pause />ПАУЗА</button>)}
            {!state.running && state.left > 0 && (<button onClick={resume} className="w-full px-4 py-3 rounded-2xl border border-stone-300 dark:border-zinc-700 flex items-center justify-center gap-2 tracking-widest"><Play />ДАЛЬШЕ</button>)}
            <button onClick={stop} className="w-full px-4 py-3 rounded-2xl border border-stone-300 dark:border-zinc-700 flex items-center justify-center gap-2 tracking-widest"><StopCircle />СБРОС</button>
          </div>
          <div className="text-sm text-zinc-500 dark:text-zinc-400">Темп: {tea.tempC}°C · Доза: {tea.gramsPer100} г/100мл</div>
        </div>
      )}
    </div>
  );
}

function MoodTab({ mood, setMood, favIds, toggleFav, onOpenTea }) {
  const recs = useMemo(() => TEAS.sort((a, b) => scoreTea(b, mood) - scoreTea(a, mood)).slice(0, 5), [mood]);
  return (
    <div className="p-4 space-y-6">
      <div className="rounded-3xl p-5 bg-gradient-to-br from-rose-50 to-rose-100 dark:from-zinc-800/50 dark:to-zinc-800/80 border border-rose-200 dark:border-zinc-700">
        <div className="text-sm text-rose-800 dark:text-amber-400 tracking-wide">Как ты сейчас?</div>
        <div className="text-xl font-semibold mt-1 tracking-wide">Выбери настроение — подберём чай</div>
        <div className="mt-3 flex gap-2 flex-wrap">{Object.keys(MOODS).map((key) => (<MoodChip key={key} mood={key} selected={mood === key} onSelect={setMood} />))}</div>
      </div>
      <div className="flex items-center justify-between">
        <div className="font-semibold text-lg tracking-wider">Рекомендации</div>
        <div className="text-xs text-zinc-500 dark:text-zinc-400 tracking-wide">для: {MOODS[mood].label}</div>
      </div>
      <div className="space-y-3">{recs.map((t) => (<TeaCard key={t.id} tea={t} onOpen={onOpenTea} fav={favIds.includes(t.id)} toggleFav={toggleFav} />))}</div>
    </div>
  );
}

function ExploreTab({ query, setQuery, filterCat, setFilterCat, favIds, toggleFav, onOpenTea }) {
  const list = useMemo(() => {
    const q = query.toLowerCase();
    return TEAS.filter((t) => (filterCat === "all" || t.category === filterCat) && (t.name.toLowerCase().includes(q) || t.notes.join(" ").toLowerCase().includes(q) || t.region?.toLowerCase().includes(q) || t.cn?.includes(q)));
  }, [query, filterCat]);
  return (
    <div className="p-4 space-y-4">
      <div className="flex gap-2">
        <div className="flex-1 relative">
          <SearchIconForInput />
          <input value={query} onChange={(e) => setQuery(e.target.value)} placeholder="Поиск чая..." className="w-full pl-10 pr-3 py-2.5 rounded-2xl border border-stone-300 bg-white dark:bg-zinc-800 dark:border-zinc-700 dark:placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-rose-300 dark:focus:ring-amber-400"/>
        </div>
        <div>
          <select value={filterCat} onChange={(e) => setFilterCat(e.target.value)} className="w-full h-full px-3 py-2.5 rounded-2xl border border-stone-300 bg-white dark:bg-zinc-800 dark:border-zinc-700 focus:outline-none focus:ring-2 focus:ring-rose-300 dark:focus:ring-amber-400">
            <option value="all">Все</option>
            {Object.entries(CATEGORY_LABELS).map(([catKey, catLabel]) => (<option key={catKey} value={catKey}>{catLabel}</option>))}
          </select>
        </div>
      </div>
      <div className="space-y-3">
        {list.map((t) => (<TeaCard key={t.id} tea={t} onOpen={onOpenTea} fav={favIds.includes(t.id)} toggleFav={toggleFav} />))}
        {list.length === 0 && (<div className="text-zinc-500 text-sm p-6 text-center border rounded-3xl dark:border-zinc-700 tracking-widest">ПУСТО</div>)}
      </div>
    </div>
  );
}

function JournalTab({ journal, addEntry, removeEntry }) {
  const [note, setNote] = useState("");
  const [teaId, setTeaId] = useState(TEAS[0]?.id || "");
  return (
    <div className="p-4 space-y-4">
      <div className="rounded-3xl border border-stone-200 dark:border-zinc-700 p-4">
        <div className="text-lg font-medium mb-2 tracking-wider">Новая запись</div>
        <div className="grid grid-cols-1 gap-2">
          <select value={teaId} onChange={(e) => setTeaId(e.target.value)} className="w-full px-3 py-2.5 rounded-xl border border-stone-300 bg-white dark:bg-zinc-800 dark:border-zinc-600">
            {TEAS.map((t) => (<option key={t.id} value={t.id}>{t.name}</option>))}
          </select>
          <textarea value={note} onChange={(e) => setNote(e.target.value)} placeholder="Ноты, эмоции, вода…" rows={3} className="w-full px-3 py-2 rounded-xl border border-stone-300 bg-white dark:bg-zinc-800 dark:border-zinc-600" />
          <button onClick={() => { if (note.trim()) { addEntry(teaId, note.trim()); setNote(""); } }} className="w-full px-4 py-2.5 rounded-xl bg-rose-700 text-white dark:bg-amber-400 dark:text-zinc-900 tracking-widest">ДОБАВИТЬ</button>
        </div>
      </div>
      <div className="space-y-3">
        {journal.length === 0 && <div className="text-sm text-zinc-500 p-6 text-center border border-stone-200 dark:border-zinc-700 rounded-3xl tracking-widest">ПОКА ПУСТО</div>}
        {[...journal].sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime()).map((j) => {
          const tea = TEAS.find((t) => t.id === j.teaId);
          return (
            <div key={j.id} className="rounded-3xl border border-stone-200 dark:border-zinc-700 p-4 flex items-start gap-3">
              <div className="w-10 h-10 rounded-2xl bg-stone-100 dark:bg-zinc-800 grid place-items-center flex-shrink-0"><Leaf /></div>
              <div className="min-w-0 flex-1">
                <div className="text-xs text-zinc-500 dark:text-zinc-400">{new Date(j.date).toLocaleString()}</div>
                <div className="font-medium tracking-wide">{tea?.name ?? j.teaId}</div>
                <div className="text-sm text-zinc-600 dark:text-stone-300 mt-1 whitespace-pre-wrap">{j.note}</div>
              </div>
              <button onClick={() => removeEntry(j.id)} className="px-3 py-2 rounded-xl border border-stone-300 dark:border-zinc-700 text-xs hover:bg-stone-100 dark:hover:bg-zinc-700 tracking-widest">УДАЛИТЬ</button>
            </div>
          );
        })}
      </div>
    </div>
  );
}

// ---------------------------
// ROOT
// ---------------------------

function App() {
  const [theme, setTheme] = useLocalStorage("teamo_theme", "light");
  const [tab, setTab] = useState("mood");
  const [mood, setMood] = useState("calm");
  const [sheetTea, setSheetTea] = useState(undefined);
  const [favIds, setFavIds] = useLocalStorage("teamo_favs", []);
  const [query, setQuery] = useState("");
  const [filterCat, setFilterCat] = useState("all");
  const [journal, setJournal] = useLocalStorage("teamo_journal", []);
  const brew = useBrewTimer();
  
  useEffect(() => {
    if (theme === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
    document.querySelector('meta[name="theme-color"]').setAttribute('content', theme === 'light' ? '#f5f5f4' : '#18181b');
  }, [theme]);

  function toggleTheme() { setTheme(t => t === 'light' ? 'dark' : 'light'); }
  function toggleFav(id) { setFavIds((ids) => (ids.includes(id) ? ids.filter((x) => x !== id) : [...ids, id])); }
  function addJournal(teaId, note) { setJournal((j) => [{ id: crypto.randomUUID(), date: new Date().toISOString(), teaId, note }, ...j]); }
  function removeJournal(id) { setJournal((j) => j.filter((x) => x.id !== id)); }
  function openTea(t) { setSheetTea(t); }
  function onStartBrew(t) { setSheetTea(undefined); brew.setTea(t); setTab("brew"); }

  return (
    <div className="w-full min-h-screen bg-gradient-to-b from-stone-50 to-stone-100 dark:from-zinc-900 dark:to-black text-zinc-800 dark:text-stone-200">
      <div className="relative">
        <TopBar title="TeaMood" toggleTheme={toggleTheme} theme={theme} />
        <main className="max-w-screen-sm mx-auto pb-24">
          {tab === "mood" && <MoodTab mood={mood} setMood={setMood} favIds={favIds} toggleFav={toggleFav} onOpenTea={openTea} />}
          {tab === "explore" && <ExploreTab query={query} setQuery={setQuery} filterCat={filterCat} setFilterCat={setFilterCat} favIds={favIds} toggleFav={toggleFav} onOpenTea={openTea} />}
          {tab === "brew" && <BrewPanel brew={brew} onPickTea={() => setTab("explore")} />}
          {tab === "journal" && <JournalTab journal={journal} addEntry={addJournal} removeEntry={removeJournal} />}
        </main>
        <BottomNav tab={tab} setTab={setTab} />
        <Sheet tea={sheetTea} open={!!sheetTea} onClose={() => setSheetTea(undefined)} onStartBrew={onStartBrew} />
      </div>
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));

    </script>
</body>
</html>

